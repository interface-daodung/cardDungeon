<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Inventory</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Style cho item ƒë√£ trang b·ªã */
    .grid-item.equipped {
      opacity: 0.5;
      pointer-events: none;
      cursor: not-allowed;
    }

    .grid-item.equipped:hover {
      opacity: 0.5;
    }

    /* Style cho n√∫t n√¢ng c·∫•p m·ªõi */
    .btn-upgrade .upgrade-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .btn-upgrade .upgrade-text {
      font-size: 12px;
      font-weight: 500;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }

    .btn-upgrade #priceUpgrade {
      font-size: 16px;
      font-weight: bold;
      color: #ffd700;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }

    /* Style khi priceUpgrade = 'max' */
    .btn-upgrade #priceUpgrade.max-level {
      font-size: 20px;
      color: white;
      font-weight: 900;
    }

    .btn-upgrade #priceUpgrade.max-level + .upgrade-text,
    .btn-upgrade .upgrade-text.hidden,
    .btn-upgrade .btn-icon.hidden {
      display: none;
    }

    /* Style cho th√¥ng b√°o popup */
    .message-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
    }

    .message-popup.show {
      opacity: 1;
    }

    .message-content {
      background-color: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 20px 40px;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 500;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      transform: translateY(-20px);
      transition: transform 0.3s ease-out;
    }

    .message-popup.show .message-content {
      transform: translateY(0);
    }
  </style>
</head>

<body class="equipments-page">

  <!-- Icon Xu + ƒëi·ªÉm -->
  <div class="score-bar fade-in">
    <span>ü™ô</span>
    <span id="score">0</span>
  </div>

  <!-- Icon setting -->
  <div class="settings-btn-wrapper fade-in">
    <span class="settings-btn">‚öôÔ∏è</span>
  </div>


  <div class="container">
    <div class="grid" id="itemGrid">
      <!-- Items s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông b·∫±ng JavaScript -->
    </div>

    <!-- 3 √¥ trang b·ªã l·ªõn -->
    <div class="equipments">
      <div class="item">
        <div class="item-bg"></div>
        <img src="" alt="Equipment 1" style="display: none;" />
      </div>
      <div class="item">
        <div class="item-bg"></div>
        <img src="" alt="Equipment 2" style="display: none;" />
      </div>
      <div class="item">
        <div class="item-bg"></div>
        <img src="" alt="Equipment 3" style="display: none;" />
      </div>
    </div>

    <!-- N√∫t quay l·∫°i -->
    <!-- <a href="menu game.html" class="back-btn">Quay l·∫°i</a> -->
  </div>
  <div class="back-btn" id="confirmBtn">X√°c Nh·∫≠n</div>

  <!-- Dialog cha -->
  <div class="item-dialog-wrapper" id="itemDialogWrapper" style="display:none;">
    <!-- Dialog ch√≠nh -->
    <div class="item-dialog">
      <!-- Header v·ªõi gradient -->
      <div class="dialog-header">
        <h2 id="dialogItemName">T√™n Item</h2>
        <button class="dialog-close" onclick="closeDialog()">√ó</button>
      </div>

      <!-- N·ªôi dung dialog -->
      <div class="dialog-content">
        <div class="item-icon-container">
          <img id="dialogItemIcon" src="" alt="icon" class="dialog-icon">
          <div class="icon-glow"></div>
        </div>
        <div class="item-info">
          <p id="dialogItemDesc">M√¥ t·∫£ item...</p>
          <div class="item-stats" id="itemStats">
            <!-- Stats s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªông -->
          </div>
        </div>
      </div>

      <!-- Thanh n√∫t ƒëi·ªÅu khi·ªÉn -->
      <div class="dialog-actions">
        <button id="btnUpgrade" class="btn-upgrade">
          <span class="btn-icon">ü™ô</span>
          <div class="upgrade-content">
            <span class="upgrade-text">N√¢ng c·∫•p</span>
            <span id="priceUpgrade">0</span>
          </div>
        </button>
        <button id="btnSelect" class="btn-select">
          <span class="btn-icon">‚úÖ</span>
          <span>L·ª±a ch·ªçn</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Th√¥ng b√°o popup -->
  <div id="messagePopup" class="message-popup" style="display: none;">
    <div class="message-content">
      <span id="messageText"></span>
    </div>
  </div>

  <!-- S·ª≠ d·ª•ng items-bundle thay v√¨ ES6 modules -->
  <script src="items-bundle.js"></script>

  <script>
    // Kh·ªüi t·∫°o ItemFactory t·ª´ items-bundle
    const itemFactory = new ItemFactory();

    // L·∫•y danh s√°ch item class
    const itemList = itemFactory.getItemClassList();

    let equippedIndices = []; // l∆∞u index item trong l∆∞·ªõi ƒëang ƒë∆∞·ª£c trang b·ªã
    let selectedItemIndex = null; // index item hi·ªán ƒëang m·ªü dialog
    let selectedFromEquip = false; // true n·∫øu m·ªü t·ª´ √¥ trang b·ªã

    // L·∫•y ph·∫ßn t·ª≠ dialog
    const dialogWrapper = document.getElementById('itemDialogWrapper');
    const dialogName = document.getElementById('dialogItemName');
    const dialogIcon = document.getElementById('dialogItemIcon');
    const dialogDesc = document.getElementById('dialogItemDesc');
    const btnUpgrade = document.getElementById('btnUpgrade');
    const btnSelect = document.getElementById('btnSelect');

    // H√†m ƒë√≥ng dialog
    function closeDialog() {
      dialogWrapper.style.display = 'none';
    }

    // L·∫•y item trong l∆∞·ªõi v√† √¥ trang b·ªã
    let gridItems = []; // S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t sau khi t·∫°o items ƒë·ªông
    const equipmentSlots = document.querySelectorAll('.equipments .item');

    // T·∫°o items ƒë·ªông
    function createItems() {
      console.log('B·∫Øt ƒë·∫ßu t·∫°o items...');
      const itemGrid = document.getElementById('itemGrid');

      itemList.forEach((itemInfo, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item';
        itemDiv.dataset.nameId = itemInfo.nameId;
        itemDiv.dataset.name = itemInfo.name;
        itemDiv.dataset.description = itemInfo.description;
        itemDiv.dataset.power = itemInfo.power;
        itemDiv.dataset.cooldown = itemInfo.cooldown;
        itemDiv.dataset.isConsumable = itemInfo.isConsumable;

        itemDiv.innerHTML = `
      <div class="item-bg"></div>
      <img src="${itemInfo.img}" alt="${itemInfo.name}" class="darken" />
    `;

        // Th√™m class ƒë·ªÉ d·ªÖ d√†ng style cho item ƒë√£ trang b·ªã
        itemDiv.classList.add('grid-item');

        itemGrid.appendChild(itemDiv);
      });

      console.log('ƒê√£ t·∫°o xong', itemList.length, 'items');

      // C·∫≠p nh·∫≠t gridItems ngay sau khi t·∫°o xong
      updateGridItems();

      // Sau khi t·∫°o xong items v√† c·∫≠p nh·∫≠t gridItems, load t·ª´ localStorage
      console.log('B·∫Øt ƒë·∫ßu load t·ª´ localStorage...');
      loadEquippedItemsFromStorage();

      // Sau khi load xong t·ª´ localStorage, setup event listeners
      console.log('Setup event listeners...');
      setupGridItemEventListeners();
    }

    // H√†m c·∫≠p nh·∫≠t gridItems
    function updateGridItems() {
      gridItems = document.querySelectorAll('.grid .item');
      console.log('Grid items updated:', gridItems);
    }

    // H√†m load c√°c item ƒë√£ ƒë∆∞·ª£c trang b·ªã t·ª´ localStorage
    function loadEquippedItemsFromStorage() {
      console.log('Ki·ªÉm tra localStorage...');
      const selectEquipments = localStorage.getItem('selectEquipments');

      if (selectEquipments) {
        try {
          const equippedNameIds = JSON.parse(selectEquipments);
          console.log('T√¨m th·∫•y equipped items:', equippedNameIds);

          if (Array.isArray(equippedNameIds) && equippedNameIds.length > 0) {
            // T√¨m c√°c item trong grid c√≥ nameId t∆∞∆°ng ·ª©ng
            equippedNameIds.forEach((nameId, slotIndex) => {
              if (slotIndex < 3) { // Ch·ªâ t·ªëi ƒëa 3 slot
                console.log('T√¨m item v·ªõi nameId:', nameId, 'cho slot:', slotIndex);
                const gridItem = Array.from(gridItems).find(item =>
                  item.dataset.nameId === nameId
                );

                if (gridItem && equipmentSlots[slotIndex]) {
                  console.log('ƒê√£ t√¨m th·∫•y grid item, trang b·ªã v√†o slot:', slotIndex);
                  // L·∫•y th√¥ng tin t·ª´ grid item
                  const imgGrid = gridItem.querySelector('img');

                  // Trang b·ªã v√†o equipment slot
                  const equipmentSlot = equipmentSlots[slotIndex];
                  const slotImg = equipmentSlot.querySelector('img');

                  // Copy dataset v√† hi·ªÉn th·ªã
                  slotImg.src = imgGrid.src;
                  slotImg.style.display = 'block';

                  // Copy dataset
                  equipmentSlot.dataset.nameId = gridItem.dataset.nameId;
                  equipmentSlot.dataset.name = gridItem.dataset.name;
                  equipmentSlot.dataset.description = gridItem.dataset.description;
                  equipmentSlot.dataset.power = gridItem.dataset.power;
                  equipmentSlot.dataset.cooldown = gridItem.dataset.cooldown;
                  equipmentSlot.dataset.isConsumable = gridItem.dataset.isConsumable;

                  // ·∫®n item trong grid
                  imgGrid.style.display = 'none';

                  // Th√™m class ƒë·ªÉ style item ƒë√£ trang b·ªã
                  gridItem.classList.add('equipped');

                  // C·∫≠p nh·∫≠t equippedIndices
                  equippedIndices[slotIndex] = Array.from(gridItems).indexOf(gridItem);
                } else {
                  console.log('Kh√¥ng t√¨m th·∫•y grid item ho·∫∑c equipment slot cho nameId:', nameId);
                }
              }
            });

            console.log('ƒê√£ load', equippedNameIds.length, 'items t·ª´ localStorage');
          }
        } catch (error) {
          console.error('L·ªói khi parse localStorage selectEquipments:', error);
        }
      } else {
        console.log('Kh√¥ng c√≥ equipped items trong localStorage');
      }
    }

    // H√†m m·ªü dialog
    function openItemDialog(name, iconSrc, desc, index, fromEquip) {
      dialogName.textContent = name;
      dialogIcon.src = iconSrc;
      dialogDesc.textContent = desc;
      selectedItemIndex = index;
      selectedFromEquip = fromEquip;

      // C·∫≠p nh·∫≠t stats
      if (fromEquip) {
        // N·∫øu click t·ª´ equipment slot, l·∫•y th√¥ng tin t·ª´ slot ƒë√≥
        const equipmentSlot = Array.from(equipmentSlots).find(slot =>
          slot.querySelector('img').src === iconSrc
        );
        if (equipmentSlot) {
          updateItemStatsFromDataset(equipmentSlot.dataset);
          // C·∫≠p nh·∫≠t gi√° n√¢ng c·∫•p cho item t·ª´ equipment slot
          const nameId = equipmentSlot.dataset.nameId;
          if (nameId) {
            const price = priceUpgrade(nameId);
            setNewPrice(price);
          }
        }
      } else if (gridItems[index]) {
        // N·∫øu click t·ª´ grid item
        updateItemStats(gridItems[index]);
        // C·∫≠p nh·∫≠t gi√° n√¢ng c·∫•p cho item t·ª´ grid
        const nameId = gridItems[index].dataset.nameId;
        if (nameId) {
          const price = priceUpgrade(nameId);
          setNewPrice(price);
        }
      } else {
        clearItemStats();
      }

      // X·ª≠ l√Ω hi·ªÉn th·ªã n√∫t
      if (fromEquip) {
        btnSelect.textContent = 'B·ªè ch·ªçn';
        btnSelect.style.display = 'inline-block';
      } else {
        // ƒê·∫øm s·ªë slot ƒë√£ c√≥ item (d·ª±a v√†o equippedIndices)
        const equippedCount = equippedIndices.filter(index => index !== undefined).length;

        if (equippedCount >= 3) {
          btnSelect.style.display = 'none';
        } else {
          btnSelect.textContent = 'L·ª±a ch·ªçn';
          btnSelect.style.display = 'inline-block';
        }
      }

      dialogWrapper.style.display = 'flex';
    }

    // H√†m c·∫≠p nh·∫≠t stats c·ªßa item t·ª´ DOM element
    function updateItemStats(item) {
      updateItemStatsFromDataset(item.dataset);
    }

    // H√†m c·∫≠p nh·∫≠t stats c·ªßa item t·ª´ dataset
    function updateItemStatsFromDataset(dataset) {
      const statsContainer = document.getElementById('itemStats');
      const power = dataset.power || '0';
      const cooldown = dataset.cooldown || '0';
      const isConsumable = dataset.isConsumable === 'true';

      statsContainer.innerHTML = `
    <div class="stat-item">
      <span class="stat-icon">‚öîÔ∏è</span>
      <span class="stat-label">S·ª©c m·∫°nh:</span>
      <span class="stat-value">+${power}</span>
    </div>
    <div class="stat-item">
      <span class="stat-icon">‚è±Ô∏è</span>
      <span class="stat-label">Cooldown:</span>
      <span class="stat-value">${cooldown}s</span>
    </div>
    <div class="stat-item">
      <span class="stat-icon">${isConsumable ? 'üç∂' : '‚öîÔ∏è'}</span>
      <span class="stat-label">Lo·∫°i:</span>
      <span class="stat-value">${isConsumable ? 'Ti√™u th·ª•' : 'V≈© kh√≠'}</span>
    </div>
  `;
    }

    // H√†m x√≥a stats
    function clearItemStats() {
      const statsContainer = document.getElementById('itemStats');
      statsContainer.innerHTML = '';
    }

    // ƒê√≥ng dialog khi click ngo√†i
    dialogWrapper.addEventListener('click', (e) => {
      if (e.target === dialogWrapper) {
        dialogWrapper.style.display = 'none';
      }
    });



    // Click n√∫t L·ª±a ch·ªçn / B·ªè ch·ªçn
    btnSelect.addEventListener('click', () => {
      if (selectedFromEquip) {
        // B·ªè ch·ªçn
        const gridItem = gridItems[selectedItemIndex];
        gridItem.querySelector('img').style.display = 'block';

        // X√≥a class equipped khi b·ªè ch·ªçn
        gridItem.classList.remove('equipped');

        // T√¨m slot ch·ª©a item c·∫ßn b·ªè ch·ªçn
        const slotToRemove = Array.from(equipmentSlots).find(slot =>
          slot.dataset.nameId === gridItem.dataset.nameId
        );

        if (slotToRemove) {
          // X√≥a item kh·ªèi slot
          slotToRemove.querySelector('img').src = '';
          slotToRemove.querySelector('img').style.display = 'none';

          // X√≥a dataset khi b·ªè ch·ªçn item
          delete slotToRemove.dataset.nameId;
          delete slotToRemove.dataset.name;
          delete slotToRemove.dataset.description;
          delete slotToRemove.dataset.power;
          delete slotToRemove.dataset.cooldown;
          delete slotToRemove.dataset.isConsumable;

          // X√≥a index kh·ªèi equippedIndices
          const slotIndex = Array.from(equipmentSlots).indexOf(slotToRemove);
          if (equippedIndices[slotIndex] !== undefined) {
            equippedIndices[slotIndex] = undefined; // ƒê√°nh d·∫•u slot tr·ªëng
          }
        }
      } else {
        // L·ª±a ch·ªçn
        // ƒê·∫øm s·ªë slot ƒë√£ c√≥ item (d·ª±a v√†o equippedIndices)
        const equippedCount = equippedIndices.filter(index => index !== undefined).length;

        if (equippedCount < 3 && !equippedIndices.some(index => index === selectedItemIndex)) {
          // Ki·ªÉm tra item n√†y ƒë√£ ƒë∆∞·ª£c trang b·ªã ·ªü slot kh√°c ch∆∞a
          const currentItemSrc = gridItems[selectedItemIndex].querySelector('img').src;
          const isDuplicate = Array.from(equipmentSlots).some(slot => {
            const slotImg = slot.querySelector('img');
            return slotImg.style.display !== 'none' && slotImg.src === currentItemSrc;
          });

          if (isDuplicate) {
            showMessage('Item n√†y ƒë√£ ƒë∆∞·ª£c trang b·ªã r·ªìi!');
            return;
          }

          // T√¨m slot tr·ªëng (kh√¥ng c√≥ item ho·∫∑c equippedIndices[slotIndex] === undefined)
          const emptySlot = Array.from(equipmentSlots).find((slot, slotIndex) => {
            return slot.querySelector('img').style.display === 'none' ||
              slot.querySelector('img').src === '' ||
              equippedIndices[slotIndex] === undefined;
          });
          if (emptySlot) {
            const gridItem = gridItems[selectedItemIndex];
            const imgGrid = gridItem.querySelector('img');

            // Copy t·∫•t c·∫£ dataset t·ª´ grid item v√†o equipment slot
            const emptySlotImg = emptySlot.querySelector('img');
            emptySlotImg.src = imgGrid.src;
            emptySlotImg.style.display = 'block';

            // Copy dataset
            emptySlot.dataset.nameId = gridItem.dataset.nameId;
            emptySlot.dataset.name = gridItem.dataset.name;
            emptySlot.dataset.description = gridItem.dataset.description;
            emptySlot.dataset.power = gridItem.dataset.power;
            emptySlot.dataset.cooldown = gridItem.dataset.cooldown;
            emptySlot.dataset.isConsumable = gridItem.dataset.isConsumable;

            imgGrid.style.display = 'none';

            // Th√™m class ƒë·ªÉ style item ƒë√£ trang b·ªã
            gridItem.classList.add('equipped');

            // T√¨m v·ªã tr√≠ slot v√† c·∫≠p nh·∫≠t equippedIndices
            const slotIndex = Array.from(equipmentSlots).indexOf(emptySlot);
            equippedIndices[slotIndex] = selectedItemIndex;
          }
        }
      }

      // T·∫Øt Dialog ngay l·∫≠p t·ª©c
      dialogWrapper.style.display = 'none';
    });

    // H√†m t√≠nh gi√° n√¢ng c·∫•p
    function priceUpgrade(nameId) {
      const level = localStorage.getItem(`${nameId}Level`);
      if (level) {
        const currentLevel = parseInt(level) + 1;
        if (currentLevel > 8) {
          return 'max'; // fix code ƒë·ªÉ gi√° tr·ªã n√†y h∆°p l·ªá v√† n·∫øu html id priceUpgrade = max th√¨ hi·ªÉn th·ªã css to h∆°n v√† ·∫©n upgrade-text
        }
        return 100 * currentLevel;
      } else {
        return 100;
      }
    }

    // H√†m hi·ªÉn th·ªã th√¥ng b√°o
    function showMessage(message) {
      const popup = document.getElementById('messagePopup');
      const messageText = document.getElementById('messageText');
      
      if (popup && messageText) {
        messageText.textContent = message;
        popup.style.display = 'flex';
        
        // Hi·ªÉn th·ªã v·ªõi animation
        setTimeout(() => {
          popup.classList.add('show');
        }, 10);
        
        // ·∫®n sau 0.8s
        setTimeout(() => {
          popup.classList.remove('show');
          setTimeout(() => {
            popup.style.display = 'none';
          }, 200);
        }, 800);
      }
    }

    // H√†m c·∫≠p nh·∫≠t gi√° v√† CSS cho priceUpgrade
    function setNewPrice(newPrice) {
      const priceElement = document.getElementById('priceUpgrade');
      const upgradeTextElement = document.querySelector('.upgrade-text');
      const btnIconElement = document.querySelector('.btn-upgrade .btn-icon');
      
      if (priceElement) {
        priceElement.textContent = newPrice;
        
        if (newPrice === 'max') {
          priceElement.classList.add('max-level');
          if (upgradeTextElement) {
            upgradeTextElement.classList.add('hidden');
          }
          if (btnIconElement) {
            btnIconElement.classList.add('hidden');
          }
        } else {
          priceElement.classList.remove('max-level');
          if (upgradeTextElement) {
            upgradeTextElement.classList.remove('hidden');
          }
          if (btnIconElement) {
            btnIconElement.classList.remove('hidden');
          }
        }
      }
    }

    // H√†m x·ª≠ l√Ω n√¢ng c·∫•p
    function Upgrading(nameId) {
      const price = priceUpgrade(nameId);
      
      if (price === 'max') {
        // Hi·ªán th√¥ng b√°o ƒë√£ c·∫•p t·ªëi ƒëa
        showMessage('Item ƒë√£ ƒë∆∞·ª£c n√¢ng c·∫•p t·ªëi ƒëa!');
        return;
      }
      
      const coinScoreTotal = localStorage.getItem('coinScoreGameTotal');
      if (coinScoreTotal >= price) {
        // Tr·ª´ ti·ªÅn
        const newCoinScore = parseInt(coinScoreTotal) - price;
        localStorage.setItem('coinScoreGameTotal', newCoinScore);
        
        // C·∫≠p nh·∫≠t l·∫°i coinScoreGameTotal v√† <span id="score">
        updateScoreDisplay();
        
        // TƒÉng level
        const level = localStorage.getItem(`${nameId}Level`);
        if (level != null) {
          localStorage.setItem(`${nameId}Level`, parseInt(level) + 1);
        } else {
          localStorage.setItem(`${nameId}Level`, 1);
        }
        
        // C·∫≠p nh·∫≠t gi√° hi·ªÉn th·ªã
        const newPrice = priceUpgrade(nameId);
        setNewPrice(newPrice);
        
        showMessage('N√¢ng c·∫•p th√†nh c√¥ng!');
      } else {
        // Hi·ªán th√¥ng b√°o kh√¥ng ƒë·ªß ti·ªÅn
        showMessage('Kh√¥ng ƒë·ªß ti·ªÅn ƒë·ªÉ n√¢ng c·∫•p!');
      }
    }

    // H√†m c·∫≠p nh·∫≠t score t·ª´ localStorage
    function updateScoreDisplay() {
      try {
        // L·∫•y gi√° tr·ªã coinScoreGameTotal t·ª´ localStorage
        const coinScoreTotal = localStorage.getItem('coinScoreGameTotal');
        const scoreValue = coinScoreTotal ? parseInt(coinScoreTotal) : 0;
        
        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã score
        const scoreElement = document.getElementById('score');
        if (scoreElement) {
          scoreElement.textContent = scoreValue.toLocaleString(); // Format s·ªë v·ªõi d·∫•u ph·∫©y
        }
      } catch (error) {
        console.error('L·ªói khi c·∫≠p nh·∫≠t score display:', error);
      }
    }

    // Ch·∫°y khi DOM load xong
    document.addEventListener('DOMContentLoaded', () => {
      createItems();
      updateScoreDisplay(); // C·∫≠p nh·∫≠t score khi trang load

      // Th√™m event listener cho n√∫t X√°c Nh·∫≠n
      const confirmBtn = document.getElementById('confirmBtn');
      if (confirmBtn) {
        confirmBtn.addEventListener('click', () => {
          // L·∫•y danh s√°ch nameId c·ªßa c√°c item ƒëang ƒë∆∞·ª£c trang b·ªã
          const equippedNameIds = [];

          equipmentSlots.forEach(slot => {
            const img = slot.querySelector('img');
            if (img.style.display !== 'none' && img.src !== '') {
              const nameId = slot.dataset.nameId;
              if (nameId) {
                equippedNameIds.push(nameId);
              }
            }
          });

          // L∆∞u v√†o localStorage
          localStorage.setItem('selectEquipments', JSON.stringify(equippedNameIds));

          // Chuy·ªÉn v·ªÅ trang index.html
          window.location.href = 'index.html';
        });
      }

      // Th√™m event listener cho n√∫t n√¢ng c·∫•p
      btnUpgrade.addEventListener('click', () => {
        if (selectedItemIndex !== null) {
          let nameId = null;
          
          if (selectedFromEquip) {
            // N·∫øu item t·ª´ equipment slot
            const equipmentSlot = Array.from(equipmentSlots).find(slot =>
              slot.querySelector('img').src === dialogIcon.src
            );
            if (equipmentSlot) {
              nameId = equipmentSlot.dataset.nameId;
            }
          } else {
            // N·∫øu item t·ª´ grid
            if (gridItems[selectedItemIndex]) {
              nameId = gridItems[selectedItemIndex].dataset.nameId;
            }
          }
          
          if (nameId) {
            Upgrading(nameId);
          }
        }
      });
    });

    // G√°n s·ª± ki·ªán click m·ªü dialog cho item trong l∆∞·ªõi
    function setupGridItemEventListeners() {
      console.log('Setup event listeners cho', gridItems.length, 'grid items');
      gridItems.forEach((item, idx) => {
        item.addEventListener('click', () => {
          const img = item.querySelector('img');

          // Ki·ªÉm tra item c√≥ th·ªÉ click ƒë∆∞·ª£c kh√¥ng
          if (img.style.display === 'none' || equippedIndices.includes(idx)) {
            return; // ƒë√£ trang b·ªã ho·∫∑c kh√¥ng th·ªÉ ch·ªçn, kh√¥ng cho m·ªü dialog
          }

          // L·∫•y th√¥ng tin t·ª´ dataset
          const name = item.dataset.name || `Item ${idx + 1}`;
          const description = item.dataset.description || 'M√¥ t·∫£ c·ªßa item';
          const power = item.dataset.power || '0';
          const cooldown = item.dataset.cooldown || '0';

          // T·∫°o m√¥ t·∫£ chi ti·∫øt
          const detailedDescription = `${description}\n\nS·ª©c m·∫°nh: ${power}\nCooldown: ${cooldown}s`;

          openItemDialog(name, img.src, detailedDescription, idx, false);
        });
      });
      console.log('ƒê√£ setup xong event listeners');
    }



    // G√°n s·ª± ki·ªán click m·ªü dialog cho item trong trang b·ªã
    equipmentSlots.forEach((slot, idx) => {
      slot.addEventListener('click', () => {
        const img = slot.querySelector('img');
        if (img.style.display === 'none' || img.src === '') return;

        // L·∫•y th√¥ng tin t·ª´ dataset c·ªßa equipment slot
        const name = slot.dataset.name || 'Item Equip';
        const description = slot.dataset.description || 'M√¥ t·∫£ trang b·ªã';
        const power = slot.dataset.power || '0';
        const cooldown = slot.dataset.cooldown || '0';

        // T·∫°o m√¥ t·∫£ chi ti·∫øt
        const detailedDescription = `${description}\n\nS·ª©c m·∫°nh: ${power}\nCooldown: ${cooldown}s`;

        const gridIndex = equippedIndices[idx] ?? equippedIndices.find(i => gridItems[i].querySelector('img').src === img.src);
        openItemDialog(name, img.src, detailedDescription, gridIndex, true);
      });
    });

    // Export ƒë·ªÉ s·ª≠ d·ª•ng trong script kh√°c (n·∫øu c·∫ßn)
    window.itemFactory = itemFactory;
    window.createItems = createItems;

  </script>

</body>

</html>